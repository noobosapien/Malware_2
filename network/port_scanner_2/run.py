import optparse
from socket import *
from threading import *

def socketScan(host, port):
    try:
        socket_connect = socket(AF_INET, SOCK_STREAM)
        socket_connect.settimeout(5)
        
        result = socket_connect.connect((host, port))
        print("[+] %d/ TCP open" %port)
    
    except Exception as exception:
        print("[-] %d/ TCP closed" % port)
        print("[-] Reason: %s" %str(exception))
    
    finally:
        socket_connect.close()


def portScanning(host, ports):
    try:
        ip = gethostbyname(host)
    
    except:
        print("[-] Cannot resolve %s: Unknown host" %host)
        return
    
    try:
        name = gethostbyaddr(ip)
        print("[+] Scan results for: \n" + ip + " " + name[0])
    
    except:
        print("[+] Scan results for: " + ip)

    print("\n")
    
    for port in ports:
        t = Thread(target=socketScan, args=(ip, int(port)))
        t.start()


def main():
    parser = optparse.OptionParser("port_scanner_2 " + "-H <host> -P <port>")
    parser.add_option("-H", dest="host", type="string", help="specify host")
    parser.add_option("-P", dest="port", type="string", help="specify port[s] seperated by comma")

    (options, args) = parser.parse_args()
    host = options.host
    ports = str(options.port).split(',')

    if(host == None) | (ports[0] == None):
        print(parser.usage)
        exit(0)

    portScanning(host, ports)


if __name__ == '__main__':
    main()
